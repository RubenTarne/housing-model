---
title: "Mortgage Debt, the Housing Wealth Effect and Financial Vulnerability"
author: "Ruben Tarne"
date: "`r Sys.Date()`"
header-includes: 
- \usepackage{amsmath, amsfonts, longtable, tabulary, calc, subfig, booktabs, array}
- \usepackage{floatrow, multirow, wrapfig, float, colortbl, pdflscape, tabu, threeparttable}
- \usepackage{threeparttablex}
- \usepackage[normalem]{ulem}
- \usepackage{makecell}
- \usepackage{xcolor}
- \floatsetup[figure]{capposition=top}
output:
  bookdown::pdf_document2:
    keep_tex: true
  html_notebook: default
  html_document:
    df_print: paged
  bookdown::html_document2: default
  pdf_document: default
  word_document: default
  bookdown: bookdown::gitbook
  bookdown::word_document2:
    toc: true
abstract: "Understanding the dynamics of households becoming financially vulnerable are useful for understanding potential risk to the financial stability stemming from commercial banks' balance sheets. Two channels increasing financial vulnerability are of interest to us. Households taking on high levels of mortgage debt and homeowners dissaving in a housing boom via a housing wealth effect, diminishing their buffer to absorb income and interest rate shocks. In this paper we want to understand the relative importance of these two channels over the housing cycle. We employ an agent-based housing market model with a housing wealth effect to understand what household-types become vulnerable (and cease to be vulnerable) due to which channel and at what time in the housing cycle. We find that in several scenarios a housing wealth effect has a considerable impact on households' financial vulnerability. Moreover, heterogeneity is important as not all borrower-types are similarly affected."
bibliography: "library.bib"
biblio-style: "apalike"
link-citations: true
---

```{r, echo=FALSE, results='hide', warning=FALSE, message=FALSE}
# This code runs the housing market model with the pre-specified parameter values - however, for micro-data analysis pre-calculations have to be done for building the data frames necessary 
# shell(paste("mvn exec:java", shQuote("-Dexec.args=-configFile src/config-files/test/agent_Data_0.155_0.888_0.98.properties -outputFolder Results/test_agent_Data_0.155_0.888_0.98 -dev")))
# shell(paste("mvn exec:java", shQuote("-Dexec.args=-configFile src/config-files/test/agent_Data_1.0_egal_0.961_noFTBSM.properties -outputFolder Results/test_agent_Data_1.0_egal_0.961_noFTBSM -dev")))

library(here)
library(bookdown)
library(kableExtra) # needs to be called here to install the necessary latex packages, see: https://cran.r-project.org/web/packages/kableExtra/vignettes/awesome_table_in_pdf.pdf
source(here::here("R code files\\R functions WP vulnerabilities.R"))
set.seed(1)
model_folder <- "test_agent_Data_0.155_0.888_0.98" # test_agent_Data_0.155_0.888_0.98 # specify the folder of the model version used for this analysis
model_folder_noFTBSM <- "test_agent_Data_0.155_0.888_0.98_noFTBSM"  #test_agent_Data_1.0_egal_0.961_noFTBSM
troughs_limits <- c(1,2) # this gives the index of the troughs spanning all figures with a housing cycle. c(2,3) would mean "paint from trough 2 to trough 3"

```

```{r message=FALSE, warning=FALSE, cache=FALSE, readData, echo=FALSE, results='hide'}
outfile <- read_csv(here::here(paste0("Results/", model_folder, "/Output-run1.csv")))
was_wave_5_hhold_eul_final <- read_sav("~/UK-WEA-survey/UKDA-7215-spss/spss/spss24/was_wave_5_hhold_eul_final.sav")
load(here::here(file = "Agent_Data_0.155_0.888_0.98.RData"))
load(here::here(file = "Agent_Data_1.0_egal_0.961_noFTBSM.RData"))
```

# The Model

## Households' consumption

@Aladangady2017 showed that the overall housing wealth effect of 4.7% in the US is exclusively driven by households with above-median debt-service-to income ratios (DSR), which he defined as potentially credit constraint. Specificly, households with above-median DSRs have an estimated housing wealth effect of 12.7%, versus 0% for households with below-average DSRs. Similarly, @Zhang2019 finds a housing wealth effect for Dutch households with above-median debt-to-income ratios (DTI) of 10.3% versus 4.1% for households with below-median DTIs. These different responses to house price swings could be driven by a collateral or a precautionary saving channel. The collateral channel would imply that with falling house prices more credit-constraint households would have less ability to withdraw house equity, lowering their consumption spending. Similarly, households getting closer to the borrowing limit (due to falling house prices) could reduce their spending to increase their precautionary wealth [@Carroll2011]. We implement a consumption function where the housing wealth effect is mirroring these findings:

```{=tex}
\begin{equation}
c^{desired}_{i,t} = c_{0} + \alpha_{i} y^{m,disp}_{i,t} + \beta_{i}b_{i,t} + \gamma_{i,t} (w^{h}_{i,t} -  q_{i,t}),
(\#eq:dConsumption)
\end{equation}
```
where $c_{0}$ represents essential consumption, $y^{m,disp}_{i,t}$ monthly disposable income (i.e. after taxes and mortgage or rental payments), $b_{i,t}$ deposits, $w^{h}_{i,t}$ gross housing wealth and $q_{i,t}$ mortgage debt. $\alpha_{i}$ and $\beta_{i}$ are dependent on the on the agents' income, becoming weaker the richer the household is. This follows the observation that The financial wealth effect ($\beta_{i}$)

The financial wealth effect seems to work more directly, potentially due to it

Mortgage debt is only acquired for purchasing houses. We decide against implementing a deliberate equity-withdrawal mechanism.

```{=tex}
\begin{equation}
c_{i,t} = 
\begin{cases}
\text{if } b_{i,t}-( c^{desired}_{i,t} - y^{m,disp}_{i,t} )<\zeta_{i,t} y^{m,disp}_{i,t} &\text{, }c_{i,t} = c_{0} + \alpha_{i} y^{m,disp}_{i,t}\\
\text{if } c^{desired}_{i,t} < c_{0} & \text{, } c_{i,t}=c_{0}\\
\text{else } & \text{, } c_{i,t}=c^{desired}_{i,t}
\end{cases}
(\#eq:consumption)
\end{equation}
```
\@ref(eq:dConsumption) bla blabla \@ref(eq:consumption)

# Financial vulnerability over the housing cycle

We define **financial vulnerability** following @Ampudia2016. First we introduce the financial margin of a household as its monthly income, less its monthly mortgage payments and a certain amount of basic living expenses:

```{=tex}
\begin{equation}
FM_{i,t} = y^{\text{net}}_{i,t} - \sum m_{i,k} - BLC,
(\#eq:FM)
\end{equation}
```
where $m$ is the monthly mortgage payment, $i$ the individiual households, $t$ the period (month) and $k$ the house the mortgage is paid for. $y^{\text{net}}_{i,t}$ is the households post-tax monthly income and $BLC$ the monhtly basic living costs, calculated as

```{=tex}
\begin{equation}
BLC = \rho y^{\text{median}},
(\#eq:BLC)
\end{equation}
```
with $\rho$ being set for $BCL$ to correspond to the poverty line, which is usually between 40% and 70% of median income [@Ampudia2016]. If a household has a negative finanical margin, it is financially distressed, meaning, income minus the mortgage payments is not enough to meet monthly basic living expenses. Then the houseshold can only meet all its expenses for a certain period of time, depending on its deposits. We define a household as finanically vulnerable if it can cover its negative financial margin for less than eight months[^1].

[^1]: The exposure at default (EAD) in the current model calibration is `r formattable::percent(mean(outfile$"EAD Ampudia (70%BLC 8m)"), digits = 1)`, which is above the target value of the share of non-performing loans (like @Ampudia2016), which is at 2.4% between 2015-2019 [@EBA2019].

```{=tex}
\begin{equation}
b_{i,t} < 8 \cdot FM_{i,t}
(\#eq:finVul)
\end{equation}
```
## Contributors to Financial Vulnerability

Following from our definition of financial vulnerability, households can become vulnerable if they:

-   Turn their financial margin negative (or more negative), by

    -   Losses to their income, by

        -   renting out less property (or to lower prices)

        -   Entering retirement

    -   Increases in their monthly mortgage payments, by buying (additional) property

-   Reduce their deposits below the threshold, by

    -   purchasing property (downpayment)

    -   Dissaving (induced by a wealth effect)

In the model, financial vulnerability is mainly driven by housing transactions and consumption. We define households to be *vulnerable by purchase* if they just purchased a house before becoming vulnerable (increases in monthly mortgage payments reduce the household's financial margin (Equation \@ref(eq:FM)) and downpayments deplete its deposits (Equation \@ref(eq:finVul)). Households are defined as *vulnerable by dissaving* when they dissaved the period they became vulnerable and did not just buy a house. Dissaving only occurs induced by a wealth effect if households hold no wealth (or negative wealth when their houses are "under water"), their consumption out of income is never above 100%[^2]. All other cases of households becoming vulnerable are defined as *by other*, including households experiencing a decline in their income, turning their financial margin negative.

[^2]: Households could become financially vulnerable just a few months after buying a house and we might classify them as *vulnerable by purchase.* However, while the purchase may have decreased the households' financial margin and the downpayments decreased the financial buffer, dissaving induced by positive net wealth was necessary to make the households financially vulnerable.

Figure \@ref(fig:contributorsVulnerability) shows when households become vulnerable and by what effect. This shows the *inflows* of vulnerable households and not the *stock* (see figure \@ref(fig:stockVulnerable). Overall, `r formattable::percent(mean(outfile$"vulnerable by dissaving")/(mean(outfile$"vulnerable by purchase") + mean(outfile$"vulnerable by dissaving") + mean(outfile$"vulnerable by other")), digits = 1)` of households becoming vulnerable do so due to dissaving, `r formattable::percent(mean(outfile$"vulnerable by purchase")/(mean(outfile$"vulnerable by purchase") + mean(outfile$"vulnerable by dissaving") + mean(outfile$"vulnerable by other")), digits = 1)` due to purchases. The increases in vulnerabiltiy by purchses are concentrated at the upswing, where most transactions happen. More households become vulnerable when house prices are hight, although this effect is less concentrated. It shows that wealth effects have a strong effect on households' financial vulnerability.

```{r, contributorsVulnerability, echo = FALSE, warning=FALSE,message=FALSE, results= FALSE, fig.align='center', fig.dim = c(6, 4), fig.scap="lala", fig.cap = "Contributors to increases in the share of financially vulnerable households over the housing cycle - 6 months rolling averages", out.width='49%'}
# get first the position of house price troughs from a smoothed HPI line
# (not as necessary for troughs as for peaks, which are more irreglar)
HPI_troughs <- find_peaks_smoothed( -outfile$`Sale HPI`, m=10, smoothedPerdiods = 6)
# translate the position of troughs into the corresponding periods to use later in graph
trough_period <- c(outfile$`Model time`[HPI_troughs])


outfile_tmp <- outfile %>%
  select("vulnerable by purchase", "vulnerable by dissaving",  "vulnerable by other")

outfile_tmp <- as.matrix(outfile_tmp)/outfile$TotalPopulation # adjust for % of total population
outfile_tmp <- as.data.frame(runmean(outfile_tmp, 6)) # build a rolling average (6 for 6 months)
colnames(outfile_tmp) <- list("purchase", "dissaving", "other") # abbreviate colnames for figure

outfile_tmp <- outfile_tmp %>%
  bind_cols(outfile$`Model time`, outfile$`Sale HPI`)%>%
  pivot_longer(c("purchase", "dissaving", "other"))  ## prepare for boxplots

colnames(outfile_tmp) <- list("Period","HousePriceIndex", "vulnerable_by", "value")
outfile_tmp$vulnerable_by <- factor(outfile_tmp$vulnerable_by, levels = c("other", "purchase", "dissaving"))

# parameters for figure
relation_rhs_lhs <- 200
color_set_1 <- cet_pal(5, name = "r3") # color sets also used for later figure

outfile_tmp %>%
  filter(Period >= trough_period[troughs_limits[1]], Period <= trough_period[troughs_limits[2]])%>%
  ggplot(aes(x=Period, fill = vulnerable_by))+
  geom_col( aes(y = value))+
  geom_line( aes(y = HousePriceIndex / relation_rhs_lhs), size=1, linetype="dashed") +
  scale_y_continuous(
    # Features of the first axis
    name = "share of vulnerable households",
    # Add a second axis and specify its features
    sec.axis = sec_axis(~ . *relation_rhs_lhs, name="House Price Index"),
    expand = expansion(mult = c(0, 0.05)) # make the barplots start at the axis
  ) +
  scale_x_continuous(expand = expansion(mult = c(0,0)))+
  # theme_classic()+
  theme(legend.position = c(.85, .85)) +
  theme(legend.background = element_blank()) +  # Remove overall border
  theme(legend.key = element_blank()) +
  scale_fill_manual(values = color_set_1)
# labs(caption = "Notes: Your long reference footnote goes in here. UNd übrigensBesonders krass\n dass das so ist")
# scale_fill_viridis_d()



```

Households cease to be financially vulnerable by:

-   Paying off their debt, by:

    -   Selling their home (for SSB and FTB agents)

    -   Regular repayment (fulfilling the 25-year mortgage contract)

    -   Death

-   Increase their deposits, by:

    -   Saving

    -   Selling property (generally the case for BTL agents)

    -   Inheriting

-   Reduce their mortgage payments, by:

    -   Selling property

    -   Paying off debt

-   Increase their income:

    -   Renting out property (BTL investors)

We classify households ceasing to be financially *vulnerable by sales* when they just sold property and ceased to be vulnerable. Those that did not just sell property and have a positive saving rate are classified as becoming *non-vulnerable by saving*. The rest --death, regular repayment, inheritance and increases in income turning the financial margin positive, but not the saving rate -- are subsumed under the label *other*.

Figure \@ref(fig:decreasesVulnerability) shows all contributors to the decreases in the share of financially vulnerable households over a housing cycle. At the point of highest housing market turnover in the upswing many households cease to be vulnerable as they sell property or save up a high enough buffer (see the turnover in figure \@ref(fig:turnover) in the Appendix). The latter being mainly households that briefly got vulnerable when purchasing property but with high enough income to save up deposits above the vulnerability threshold quickly. The saving factor seems to be dominant in all other parts of the cycle, when transaction turnover is lower.

```{r fig.align='center', fig.cap="Contributors to increases in the share of financially vulnerable households over the housing cycle - 6 months rolling averages", message=FALSE, warning=FALSE, decreasesVulnerability, echo=FALSE, out.width='49%', results=FALSE}
# get first the position of house price troughs from a smoothed HPI line
# (not as necessary for troughs as for peaks, which are more irreglar)
HPI_troughs <- find_peaks_smoothed( -outfile$`Sale HPI`, m=10, smoothedPerdiods = 6)
# translate the position of troughs into the corresponding periods to use later in graph
trough_period <- c(outfile$`Model time`[HPI_troughs])


outfile_tmp <- outfile %>%
  select("non-vulnerable by sale", "non-vulnerable by saving",  "non-vulnerable by other")

outfile_tmp <- as.matrix(outfile_tmp)/outfile$TotalPopulation # adjust for % of total population
outfile_tmp <- as.data.frame(runmean(outfile_tmp, 6)) # build a rolling average (6 for 6 months)
colnames(outfile_tmp) <- list("sale", "saving", "other") # abbreviate colnames for figure

outfile_tmp <- - outfile_tmp  # convert values to negative values for graph

outfile_tmp <- outfile_tmp %>%
  bind_cols(outfile$`Model time`, outfile$`Sale HPI`)%>%
  pivot_longer(c("sale", "saving", "other"))  ## prepare for boxplots

colnames(outfile_tmp) <- list("Period","HousePriceIndex", "non-vulnerable by", "value")
outfile_tmp$`non-vulnerable by` <- factor(outfile_tmp$`non-vulnerable by`, levels = c("other", "sale", "saving"))

# parameters for figure
relation_rhs_lhs <- 500
color_set_1 <- cet_pal(5, name = "r3") # color sets also used for later figure

outfile_tmp %>%
    filter(Period >= trough_period[troughs_limits[1]], Period <= trough_period[troughs_limits[2]])%>%
  ggplot(aes(x=Period, fill = `non-vulnerable by`))+
  geom_col( aes(y = value))+
  geom_line( aes(y = (HousePriceIndex / relation_rhs_lhs)), size=1, linetype="dashed") +
  scale_y_continuous(
    # Features of the first axis
    name = "share of vulnerable households",
    # Add a second axis and specify its features
    sec.axis = sec_axis(~ . *relation_rhs_lhs, name="House Price Index"),
    expand = expansion(mult = c(0, 0)) # make the barplots start at the axis
  ) +
  scale_x_continuous(expand = expansion(mult = c(0,0)))+
  # theme_classic()+
  theme(legend.position = c(.85, .85)) +
  theme(legend.background = element_blank()) +  # Remove overall border
  theme(legend.key = element_blank()) +
  scale_fill_manual(values = color_set_1)
# labs(caption = "Notes: Your long reference footnote goes in here. UNd übrigensBesonders krass\n dass das so ist")
# scale_fill_viridis_d()


```

Households can be vulnerable for different periods of time. After looking at the *flows* of households becoming and ceasing to be financially vulnerable, we will look at the *stock* of financially vulnerable households. Figure \@ref(fig:stockVulnerable) shows the stock of vulnerable households over the house price cycle by the reason households became vulnerable. Overall, the share of vulnerable households is moving procyclically with the house price cycle. The share of households vulnerable by purchases increases with housing market turnover (figure \@ref(fig:turnover)) and when it reaches its peak, the share of households vulnerable by purchase decrease steadily. Households financially vulnerable by dissaving are increase when prices are high and decrease when they are low (over the whole simulation run the highest correlation with house prices is at lag = `r ccf(outfile$"nowVul Dissaving", outfile$"Sale HPI")$lag[which.max(ccf(outfile$"nowVul Dissaving", outfile$"Sale HPI")$acf)]` - see figure \@ref(fig:crossCorrelation)). High house prices induce dissaving due to high net housing wealth for households with above-median DSRs. 

Overall, `r formattable::percent(mean(outfile$"nowVul Dissaving")/(mean(outfile$"nowVul Purchase") + mean(outfile$"nowVul Dissaving") + mean(outfile$"nowVul Other")), digits = 1)` of financially vulnerable households are so due to dissaving, `r formattable::percent(mean(outfile$"nowVul Purchase")/(mean(outfile$"nowVul Purchase") + mean(outfile$"nowVul Dissaving") + mean(outfile$"nowVul Other")), digits = 1)` due to purchases. The discrepancy of the importance of the dissaving channel when looking at the changes in financial vulnerability and overall vulnerability suggests that on average households becoming vulnerable by dissaving stay vulnerable for a briefer period than those vulnerable by property purchases.

```{r, stockVulnerable, echo = FALSE, warning=FALSE,message=FALSE, results= FALSE, fig.align='center', fig.cap = "Share of financially vulnerable households", fig.subcap= c("cause of vulnerability", "agent classes vulnerable"),  out.width='49%', fig.show='hold'}

outfile_tmp <- outfile %>%
  select("nowVul Purchase", "nowVul Dissaving",  "nowVul Other")

outfile_tmp <- as.matrix(outfile_tmp)/outfile$TotalPopulation # adjust for % of total population
outfile_tmp <- as.data.frame(runmean(outfile_tmp, 6)) # build a rolling average (6 for 6 months)
colnames(outfile_tmp) <- list("purchase", "dissaving", "other") # abbreviate colnames for figure

outfile_tmp <- outfile_tmp %>%
  bind_cols(outfile$`Model time`, outfile$`Sale HPI`)%>%
  pivot_longer(c("purchase", "dissaving", "other"))  ## prepare for boxplots

colnames(outfile_tmp) <- list("Period","HousePriceIndex", "vulnerable_by", "value")
outfile_tmp$vulnerable_by <- factor(outfile_tmp$vulnerable_by, levels = c("other", "purchase", "dissaving"))

# parameters for figure
relation_rhs_lhs <- 20


outfile_tmp %>%
    filter(Period >= trough_period[troughs_limits[1]], Period <= trough_period[troughs_limits[2]])%>%
  ggplot(aes(x=Period, fill = vulnerable_by))+
  geom_col( aes(y = value))+
  geom_line( aes(y = HousePriceIndex / relation_rhs_lhs), size=1, linetype="dashed") +
  scale_y_continuous(
    # Features of the first axis
    name = "share of vulnerable households",
    # Add a second axis and specify its features
    sec.axis = sec_axis(~ . *relation_rhs_lhs, name="House Price Index"),
    expand = expansion(mult = c(0, 0.05)) # make the barplots start at the axis
  ) +
  scale_x_continuous(expand = expansion(mult = c(0,0)))+
  # theme_classic()+
  theme(legend.position = "bottom") +
  theme(legend.background = element_blank()) +  # Remove overall border
  theme(legend.key = element_blank()) +
  scale_fill_manual(values = color_set_1)
# labs(caption = "Notes: Your long reference footnote goes in here. UNd übrigensBesonders krass\n dass das so ist")
# scale_fill_viridis_d()

###########################################################################################
###########################################################################################
# vulnerability by agent-class

outfile_tmp <- outfile %>%
  select("nVul activeBTL (70%BLC 8m)", "nVul SSB (70%BLC 8m)",  "nVul inFirstHome (70%BLC 8m)")

outfile_tmp <- as.matrix(outfile_tmp)/outfile$TotalPopulation # adjust for % of total population
outfile_tmp <- as.data.frame(runmean(outfile_tmp, 6)) # build a rolling average (6 for 6 months)
colnames(outfile_tmp) <- list("BTL", "SSB", "FTB") # abbreviate colnames for figure

outfile_tmp <- outfile_tmp %>%
  bind_cols(outfile$`Model time`, outfile$`Sale HPI`)  %>%
  pivot_longer(c("BTL", "SSB", "FTB"))  ## prepare for boxplots

colnames(outfile_tmp) <- list("Period","HousePriceIndex", "agent class", "value")
# colnames(outfile_tmp) <- list("BTL", "SSB", "FTB", "Period","HousePriceIndex")
outfile_tmp$`agent class` <- factor(outfile_tmp$`agent class`, levels = c("BTL", "FTB", "SSB"))

# parameters for figure
relation_rhs_lhs <- 40

color_set_3 <- c("darkred", "dodgerblue3", "darkgreen")

outfile_tmp %>%
    filter(Period >= trough_period[troughs_limits[1]], Period <= trough_period[troughs_limits[2]])%>%
  ggplot(aes(x=Period, color = `agent class`))+
  geom_line( aes(y = value), size = 1)+
  geom_line( aes(y = HousePriceIndex / relation_rhs_lhs), size=1,color = "black", linetype="dashed") +
  scale_y_continuous(
    # Features of the first axis
    name = "share of vulnerable households",
    # Add a second axis and specify its features
    sec.axis = sec_axis(~ . *relation_rhs_lhs, name="House Price Index"),
    expand = expansion(mult = c(0, 0.05)) # make the barplots start at the axis
  ) +
  scale_x_continuous(expand = expansion(mult = c(0,0)))+
  # theme_classic()+
  theme(legend.position = "bottom") +
  theme(legend.background = element_blank()) +  # Remove overall border
  theme(legend.key = element_blank()) +
scale_fill_manual(values = color_set_3)


```

## Financial vulnerability by agent-class



```{r, fig.cap="Share of financially vulnerable households by cause and agent-class", fig.subcap=c("Wealth and Assets", "Model output"), fig.show='hold', message=FALSE, warning=FALSE,  results=FALSE,  echo=FALSE, out.height= '66%'}
outfile_tmp <- outfile %>%
  select( "nowVul Purchase BTL",	 "nowVul Dissaving BTL",	 "nowVul Other BTL",	"nowVul Purchase SSB",	 "nowVul Dissaving SSB",	 
          "nowVul Other SSB",	 "nowVul Purchase FTB",	 "nowVul Dissaving FTB",	 "nowVul Other FTB")


outfile_tmp <- as.matrix(outfile_tmp)/outfile$TotalPopulation # adjust for % of total population
outfile_tmp <- as.data.frame(runmean(outfile_tmp, 12)) # build a rolling average (6 for 6 months)

colnames(outfile_tmp) <- list("nowVul Purchase BTL",	 "nowVul Dissaving BTL",	 "nowVul Other BTL",	"nowVul Purchase SSB",	 "nowVul Dissaving SSB",	 
                              "nowVul Other SSB",	 "nowVul Purchase FTB",	 "nowVul Dissaving FTB",	 "nowVul Other FTB") # abbreviate colnames for figure



outfile_tmp <- outfile_tmp %>%
  bind_cols(outfile$`Model time`, outfile$`Sale HPI`)%>%
  pivot_longer(c("nowVul Purchase BTL",	 "nowVul Dissaving BTL",	 "nowVul Other BTL",	"nowVul Purchase SSB",	 "nowVul Dissaving SSB",	 
                 "nowVul Other SSB",	 "nowVul Purchase FTB",	 "nowVul Dissaving FTB",	 "nowVul Other FTB"))  ## prepare for boxplots

colnames(outfile_tmp) <- list("Period","HousePriceIndex", "vulnerable_by", "value")
outfile_tmp <- outfile_tmp %>%
  mutate(agent = case_when(vulnerable_by %in%c ("nowVul Purchase BTL",	 "nowVul Dissaving BTL",	 "nowVul Other BTL") ~ "BTL",
                           vulnerable_by %in% c("nowVul Purchase SSB",	 "nowVul Dissaving SSB",	 "nowVul Other SSB") ~ "SSB",
                           vulnerable_by %in% c("nowVul Purchase FTB",	 "nowVul Dissaving FTB",	 "nowVul Other FTB") ~ "FTB"))%>%
  mutate(vulnerable_by = case_when(vulnerable_by %in% c("nowVul Purchase BTL", "nowVul Purchase SSB",	"nowVul Purchase FTB") ~ "purchase",
                                   vulnerable_by %in% c("nowVul Dissaving BTL", "nowVul Dissaving SSB", "nowVul Dissaving FTB") ~ "dissaving",
                                   vulnerable_by %in% c( "nowVul Other BTL", "nowVul Other SSB", "nowVul Other FTB") ~ "other")) %>%
  mutate(value = formattable::percent(value))

outfile_tmp$vulnerable_by <- factor(outfile_tmp$vulnerable_by, levels = c("other", "purchase", "dissaving"))
# outfile_tmp$vulnerable_by <- factor(outfile_tmp$vulnerable_by, levels = c("other", "dissaving", "purchase"))

# parameters for figure
relation_rhs_lhs <- 40

outfile_tmp %>%
    filter(Period >= trough_period[troughs_limits[1]], Period <= trough_period[troughs_limits[2]])%>%
  ggplot(aes(x=Period, fill = vulnerable_by))+
  geom_col( aes(y = value))+
  geom_line( aes(y = HousePriceIndex / relation_rhs_lhs), size=0.25, linetype="dashed") +
  scale_y_continuous(
    # Features of the first axis
    name = "share of vulnerable households",
    # Add a second axis and specify its features
    sec.axis = sec_axis(~ . *relation_rhs_lhs, name="House Price Index"),
    expand = expansion(mult = c(0, 0.05)) # make the barplots start at the axis
  ) +
  scale_x_continuous(expand = expansion(mult = c(0,0)))+
  # theme_classic()+
  theme(legend.position = "bottom") +
  theme(legend.background = element_blank()) +  # Remove overall border
  theme(legend.key = element_blank()) +
  scale_fill_manual(values = color_set_1)+
  facet_wrap( ~ agent)
# labs(caption = "Notes: Your long reference footnote goes in here. UNd übrigensBesonders krass\n dass das so ist")
```

```{r, fig.cap="Causes for changes in the vulnerability of agent-classes", fig.subcap=c("Wealth and Assets", "Model output"), fig.show='hold', message=FALSE, warning=FALSE,  results=FALSE,  echo=FALSE}
outfile_tmp <- outfile %>%
  select("Vulnerable By Purchase BTL",	"Vulnerable By Purchase SSB",	 "Vulnerable By Purchase InFirstHome",	"Vulnerable By Consumption BTL",	 "Vulnerable By Consumption SSB",	 "Vulnerable By Consumption InFirstHome",	"Vulnerable By Other BTL",	 "Vulnerable By Other SSB",	 "Vulnerable By Other InFirstHome",	"Non-Vulnerable Because Sale BTL",	 "Non-Vulnerable Because Sale SSB",	 "Non-Vulnerable Because Sale InFirstHome", "Non-Vulnerable Because Saving BTL",	 "Non-Vulnerable Because Saving SSB",	 "Non-Vulnerable Because Saving InFirstHome",	 "Non-Vulnerable Because Other BTL",	 "Non-Vulnerable Because Other SSB",	 "Non-Vulnerable Because Other InFirstHome",
         "nVul activeBTL (70%BLC 8m)", "nVul inFirstHome (70%BLC 8m)",	"nVul SSB (70%BLC 8m)")

# set non-vulnerable values as negative
outfile_tmp <- outfile_tmp %>%
  mutate(`Non-Vulnerable Because Sale BTL` = - `Non-Vulnerable Because Sale BTL`,	 `Non-Vulnerable Because Sale SSB` = - `Non-Vulnerable Because Sale SSB`, 
         `Non-Vulnerable Because Sale InFirstHome` = - `Non-Vulnerable Because Sale InFirstHome`, `Non-Vulnerable Because Saving BTL` = - `Non-Vulnerable Because Saving BTL`,
         `Non-Vulnerable Because Saving SSB` = - `Non-Vulnerable Because Saving SSB`,	 `Non-Vulnerable Because Saving InFirstHome` = - `Non-Vulnerable Because Saving InFirstHome`,
         `Non-Vulnerable Because Other BTL` = - `Non-Vulnerable Because Other BTL`,	 `Non-Vulnerable Because Other SSB` = - `Non-Vulnerable Because Other SSB`,	
         `Non-Vulnerable Because Other InFirstHome` = - `Non-Vulnerable Because Other InFirstHome`) 


outfile_tmp <- as.matrix(outfile_tmp)/outfile$TotalPopulation # adjust for % of total population
outfile_tmp <- as.data.frame(runmean(outfile_tmp, 12)) # build a rolling average (6 for 6 months)

colnames(outfile_tmp) <- list("Vulnerable By Purchase BTL",	"Vulnerable By Purchase SSB",	 "Vulnerable By Purchase InFirstHome",	"Vulnerable By Consumption BTL",	 "Vulnerable By Consumption SSB",	 "Vulnerable By Consumption InFirstHome",	"Vulnerable By Other BTL",	 "Vulnerable By Other SSB",	 "Vulnerable By Other InFirstHome",	"Non-Vulnerable Because Sale BTL",	 "Non-Vulnerable Because Sale SSB",	 "Non-Vulnerable Because Sale InFirstHome", "Non-Vulnerable Because Saving BTL",	 "Non-Vulnerable Because Saving SSB",	 "Non-Vulnerable Because Saving InFirstHome",	 "Non-Vulnerable Because Other BTL",	 "Non-Vulnerable Because Other SSB",	 "Non-Vulnerable Because Other InFirstHome",
         "nVul activeBTL", "nVul inFirstHome",	"nVul SSB") 

## build a file with periods, HPI and the change in share of vulnerable households by agent-class
outfile_tmp1 <- outfile_tmp %>%
  mutate(change_BTL = `nVul activeBTL` - lag(`nVul activeBTL`),
         change_SSB = `nVul SSB` - lag(`nVul SSB`),
         change_FTB = `nVul inFirstHome` - lag(`nVul inFirstHome`))%>%
  select(-c(`nVul activeBTL`, `nVul SSB`,`nVul inFirstHome`, "Vulnerable By Purchase BTL",	"Vulnerable By Purchase SSB",	 "Vulnerable By Purchase InFirstHome",	"Vulnerable By Consumption BTL",	 "Vulnerable By Consumption SSB",	 "Vulnerable By Consumption InFirstHome",	"Vulnerable By Other BTL",	 "Vulnerable By Other SSB",	 "Vulnerable By Other InFirstHome",	"Non-Vulnerable Because Sale BTL",	 "Non-Vulnerable Because Sale SSB",	 "Non-Vulnerable Because Sale InFirstHome", "Non-Vulnerable Because Saving BTL",	 "Non-Vulnerable Because Saving SSB",	 "Non-Vulnerable Because Saving InFirstHome",	 "Non-Vulnerable Because Other BTL",	 "Non-Vulnerable Because Other SSB",	 "Non-Vulnerable Because Other InFirstHome")) %>%
  bind_cols(outfile$`Model time`) %>%
  pivot_longer(c("change_BTL", "change_SSB", "change_FTB"))
colnames(outfile_tmp1) <- list("Period", "agent_change", "change")

outfile_tmp1 <- outfile_tmp1 %>%
  mutate(agent = case_when(agent_change == "change_BTL" ~ "BTL",
                           agent_change == "change_SSB" ~ "SSB",
                           agent_change == "change_FTB" ~ "FTB"))

# build a data frame where the causes for vulnerability become a "factor" and the values are gathered in one column (for graph)
outfile_tmp <- outfile_tmp %>%
  bind_cols(outfile$`Model time`, outfile$`Sale HPI`) %>%
  select(-c(`nVul activeBTL`, `nVul SSB`,`nVul inFirstHome`))%>%
  pivot_longer(c("Vulnerable By Purchase BTL",	"Vulnerable By Purchase SSB",	 "Vulnerable By Purchase InFirstHome",	"Vulnerable By Consumption BTL",	 "Vulnerable By Consumption SSB",	 "Vulnerable By Consumption InFirstHome",	"Vulnerable By Other BTL",	 "Vulnerable By Other SSB",	 "Vulnerable By Other InFirstHome",	"Non-Vulnerable Because Sale BTL",	 "Non-Vulnerable Because Sale SSB",	 "Non-Vulnerable Because Sale InFirstHome", "Non-Vulnerable Because Saving BTL",	 "Non-Vulnerable Because Saving SSB",	 "Non-Vulnerable Because Saving InFirstHome",	 "Non-Vulnerable Because Other BTL",	 "Non-Vulnerable Because Other SSB",	 "Non-Vulnerable Because Other InFirstHome")) 

colnames(outfile_tmp) <- list("Period","HousePriceIndex", "vulnerability", "value")

outfile_tmp <- outfile_tmp %>%
  mutate(agent = case_when(vulnerability %in%c( "Vulnerable By Purchase BTL"  , "Vulnerable By Consumption BTL", "Vulnerable By Other BTL", 
                                                "Non-Vulnerable Because Sale BTL" , "Non-Vulnerable Because Saving BTL" , "Non-Vulnerable Because Other BTL") ~ "BTL",
                           vulnerability %in% c("Vulnerable By Purchase SSB", "Vulnerable By Consumption SSB", "Vulnerable By Other SSB",
                                                "Non-Vulnerable Because Sale SSB", "Non-Vulnerable Because Saving SSB","Non-Vulnerable Because Other SSB") ~ "SSB",
                           vulnerability %in% c("Vulnerable By Purchase InFirstHome", "Vulnerable By Consumption InFirstHome", "Vulnerable By Other InFirstHome",
                                                "Non-Vulnerable Because Sale InFirstHome", "Non-Vulnerable Because Saving InFirstHome","Non-Vulnerable Because Other InFirstHome") ~ "FTB"))%>%
  mutate(cause = case_when(vulnerability %in% c("Vulnerable By Purchase BTL",	"Vulnerable By Purchase SSB",	 "Vulnerable By Purchase InFirstHome") ~ "vulnerable by purchase",
                           vulnerability %in% c("Non-Vulnerable Because Sale BTL",	 "Non-Vulnerable Because Sale SSB",	 "Non-Vulnerable Because Sale InFirstHome") ~ "non-vulnerable by sale",
                           vulnerability %in% c("Vulnerable By Consumption BTL",	 "Vulnerable By Consumption SSB",	 "Vulnerable By Consumption InFirstHome") ~ "vulnerable by dissaving",
                           vulnerability %in% c("Non-Vulnerable Because Saving BTL",	 "Non-Vulnerable Because Saving SSB",	 "Non-Vulnerable Because Saving InFirstHome") ~ "non-vulnerable by saving",
                           vulnerability %in% c("Vulnerable By Other BTL",	 "Vulnerable By Other SSB",	 "Vulnerable By Other InFirstHome") ~ "vulnerable by other",
                           vulnerability %in% c("Non-Vulnerable Because Other BTL",	 "Non-Vulnerable Because Other SSB",	 "Non-Vulnerable Because Other InFirstHome") ~ "non-vulnerable by other"))

# outfile_tmp$vulnerable_by <- factor(outfile_tmp$vulnerable_by, levels = c("other", "purchase", "dissaving"))
# 
# #### Join tables
outfile_tmp <- left_join(outfile_tmp, outfile_tmp1, by = c("Period", "agent"))%>%
  mutate(value = formattable::percent(value),
         change = formattable::percent(change))

# parameters for figure
relation_rhs_lhs <- 1000

color_set_2 <- cet_pal(6, name = "r1") 

dat_text <- data.frame(
  label = c("change \nrate", "house price \nindex (rhs)"),
  Period = c(mean(c(trough_period[troughs_limits[1]],trough_period[troughs_limits[2]])+10), mean(c(trough_period[troughs_limits[1]],trough_period[troughs_limits[2]]))+10), # +10 here to shift to the right
  agent   = c("SSB", "SSB"),
  value = c(- 0.0005, 0.0015),
  # value = -mean(range(outfile_tmp$value)), 
  cause = c("vulnerable by other", "vulnerable by other")) # this is arbitrary, but otherwise it will not plot

p <- outfile_tmp %>%
  filter(Period >= trough_period[troughs_limits[1]], Period <= trough_period[troughs_limits[2]])%>%
  ggplot(aes(x=Period, fill = cause))+
  geom_col( aes(y = value))+
  geom_line( aes(y = change), size=0.5, color = "darkred")+
  geom_line( aes(y = HousePriceIndex / relation_rhs_lhs), size=0.25, linetype="dashed") +
  scale_y_continuous(
    # Features of the first axis
    name = "share of vulnerable households",
    # Add a second axis and specify its features
    sec.axis = sec_axis(~ . *relation_rhs_lhs, name="House Price Index"),
    expand = expansion(mult = c(0, 0.05)) # make the barplots start at the axis
  ) +
  scale_x_continuous(expand = expansion(mult = c(0,0)))+
  # theme_classic()+
  theme(legend.position = "bottom") +
  theme(legend.background = element_blank()) +  # Remove overall border
  theme(legend.key = element_blank()) +
  scale_fill_manual(values = color_set_2)+
  facet_wrap( ~ agent)
  p+ geom_text(data = dat_text, aes(y= value), hjust = 0.1, vjust = 0.5, label = c("change \nrate", "house price \nindex (rhs)"), color = c("darkred","black"), size=3)
# 
#   annotate("text", x = mean(c(trough_period[2],trough_period[3])), y = mean(range(outfile_tmp$value)),hjust=-0.5, vjust = 13, label = c"change rate", color = "darkred", size = 3)
# labs(caption = "Notes: Your long reference footnote goes in here. UNd übrigensBesonders krass\n dass das so ist")
```

# (APPENDIX) Appendix {.unnumbered}

# Calibration
Here should be a table with the moments I want to match

- Core indicators by the BoE
- wealth inequality
- deposits/credit
- average deposit? - do I have that?
- median DSR vul HH
- median DSR non-vul HH
- share of vul HH in indebted HH (I use this due to WEA data constraints)
- median Age vul HH
- median Age non-vul HH

```{r BoE_CoreIndicators, message=FALSE, warning=FALSE,  echo=FALSE}
# build data frame with the core indicators
coreIndicators <- data.frame(row.names = ("Model Output"),Debt_to_income_ratio =mean(rowMeans(read_csv(here::here(paste0("Results/",model_folder,"/coreIndicator-debtToIncome.csv")), col_names = FALSE), na.rm = TRUE)),
                         OO_debt_to_income_ratio = mean(rowMeans(read_csv(here::here(paste0("Results/",model_folder,"/coreIndicator-ooDebtToIncome.csv")), col_names = FALSE), na.rm = TRUE)),
                         OO_LTI_mean_above_median = mean(rowMeans(read_csv(here::here(paste0("Results/",model_folder,"/coreIndicator-ooLTI.csv")), col_names = FALSE), na.rm = TRUE)),
                         OO_LTV_mean_above_median = mean(rowMeans(read_csv(here::here(paste0("Results/",model_folder,"/coreIndicator-ooLTVAboveMedian.csv")), col_names = FALSE), na.rm = TRUE)),
                         BTL_LTV_ratio = mean(rowMeans(read_csv(here::here(paste0("Results/",model_folder,"/coreIndicator-btlLTV.csv")), col_names = FALSE), na.rm = TRUE)),
                         # OO_LTV_mean = mean(rowMeans(read_csv(here::here(paste0("Results/",model_folder,"/coreIndicator-ooLTV.csv")), col_names = FALSE), na.rm = TRUE)),
                         Housing_transactions_month = mean(rowMeans(read_csv(here::here(paste0("Results/",model_folder,"/coreIndicator-housingTransactions.csv")), col_names = FALSE), na.rm = TRUE)),
                         Mortgage_approvals = mean(rowMeans(read_csv(here::here(paste0("Results/",model_folder,"/coreIndicator-mortgageApprovals.csv")), col_names = FALSE), na.rm = TRUE)),
                         Advances_to_homemovers = mean(rowMeans(read_csv(here::here(paste0("Results/",model_folder,"/coreIndicator-advancesToMovers.csv")), col_names = FALSE), na.rm = TRUE)),
                         Advances_to_FTB = mean(rowMeans(read_csv(here::here(paste0("Results/",model_folder,"/coreIndicator-advancesToFTB.csv")), col_names = FALSE), na.rm = TRUE)),
                         Advances_to_BTL = mean(rowMeans(read_csv(here::here(paste0("Results/",model_folder,"/coreIndicator-advancesToBTL.csv")), col_names = FALSE), na.rm = TRUE)),
                         House_price_to_income_ratio = mean(rowMeans(read_csv(here::here(paste0("Results/",model_folder,"/coreIndicator-priceToIncome.csv")), col_names = FALSE), na.rm = TRUE)),
                         Rental_Yield = mean(rowMeans(read_csv(here::here(paste0("Results/",model_folder,"/coreIndicator-RentalYield.csv")), col_names = FALSE), na.rm = TRUE))
                         # Spreads_in_bp = mean(rowMeans(read_csv(here::here(paste0("Results/",model_folder,"/coreIndicator-interestRateSpread.csv")), col_names = FALSE), na.rm = TRUE)),
                         # BTL_share = mean(rowMeans(read_csv(here::here(paste0("Results/",model_folder,"/coreIndicator-BTLMarketShare.csv")), col_names = FALSE), na.rm = TRUE))
                         )
# adjsut from % to double values
coreIndicators <- coreIndicators %>%
  mutate(Debt_to_income_ratio = Debt_to_income_ratio / 100, 
         OO_debt_to_income_ratio = OO_debt_to_income_ratio / 100,
         BTL_LTV_ratio = BTL_LTV_ratio / 100,
         OO_LTV_mean_above_median = OO_LTV_mean_above_median / 100,
         Rental_Yield = Rental_Yield / 100)

# read the excel of the Bank of England's core indicators (from end 2018)
# as the table is not easily read due to its formatting, I clean the data first
BoE_coreIndicators <- as.data.frame(read_excel(path = here::here("statistical output R/Bank of England core indicators time series.xlsx")))
# name the columns
names(BoE_coreIndicators) <- c("Indicator", "sub_Indicator",		"Average 1987-2006(b)",	"Average 2006(c)",	"Minimum since 1987(b)",	"Maximum since 1987(b)",	"Previous value (oya)",	"Latest value (as of 16 November 2018)", "NA")


# read the rows where the "subindicator" is named. This could lead to errors if the names of the indicators change in the table (for instance when using newer versions)
coreIndicators_From_BoE <- data.frame(Debt_to_income_ratio = t( filter(BoE_coreIndicators, sub_Indicator %in% "of which: mortgages(h)")[3:8]), # subgroup of Household debt to income ratio(g)
                                      OO_debt_to_income_ratio = t(filter(BoE_coreIndicators, sub_Indicator %in% "of which: owner occupier mortgages(i)")[3:8]), # subgroup of Household debt to income ratio(g)
                         OO_LTI_mean_above_median = t(filter(BoE_coreIndicators, sub_Indicator %in% "Owner-occupier mortgage LTI ratio (mean above the median)(d)")[3:8]), # Owner-occupier mortgage LTI ratio (mean above the median)(d)
                         OO_LTV_mean_above_median = t(filter(BoE_coreIndicators, sub_Indicator %in% "Owner-occupier mortgage LTV ratio (mean above the median)(d)")[3:8]),
                         BTL_LTV_ratio = t(filter(BoE_coreIndicators, sub_Indicator %in% "Buy-to-let mortgage LTV ratio (mean)(e)")[3:8]),
                         # OO_LTV_mean = filter(BoE_coreIndicators, sub_Indicator %in% "Buy-to-let mortgage LTV ratio (mean)(e)")[3:8],
                         Housing_transactions_month = t(filter(BoE_coreIndicators, sub_Indicator %in% "Housing Transactions(k)")[3:8]),
                         Mortgage_approvals = t(filter(BoE_coreIndicators, sub_Indicator %in% "Approvals of loans secured on dwellings(j)")[3:8]),
                         Advances_to_homemovers = t(filter(BoE_coreIndicators, sub_Indicator %in% "Advances to homemovers(l)")[3:8]),
                         Advances_to_FTB = t(filter(BoE_coreIndicators, sub_Indicator %in% "Advances to first time buyers(l)")[3:8]),
                         Advances_to_BTL = t(filter(BoE_coreIndicators, sub_Indicator %in% "Advances to buy-to-let purchasers(l)")[3:8]),
                         House_price_to_income_ratio = t(filter(BoE_coreIndicators, sub_Indicator %in% "House price to household disposable income ratio(p)")[3:8]),
                         Rental_Yield = t(filter(BoE_coreIndicators, sub_Indicator %in% "Rental yield(q)")[3:8])
                         )

# add row names and make cells numeric
coreIndicators_From_BoE <- as.data.frame(row.names = c("Average 1987-2006(b)",	"Average 2006(c)",	"Minimum since 1987(b)",	"Maximum since 1987(b)",	"Previous value (oya)",	"Latest value (as of 16 November 2018)"), sapply(coreIndicators_From_BoE, as.numeric))

# combine BoE and model data (transpose it too)
coreIndicatorsDisplay <- as.data.frame(t(bind_rows(coreIndicators_From_BoE, coreIndicators)))
coreIndicatorsDisplay <- as.data.frame(coreIndicatorsDisplay, row.names = c("Debt to income",
                                                                          "SSB debt to income",
                                                                          "SSB LTI ratio (mean above the median)",
                                                                          "SSB LTV ratio (mean above the median)",
                                                                          "BTL LTV ratio (mean)",
                                                                          "Monthly Housing Transactions",
                                                                          "Approvals of mortages",
                                                                          "Advances to homemovers",
                                                                          "Advances to FTB",
                                                                          "Advances to BTL",
                                                                          "House price to income ratio",
                                                                          "Rental yield"))

# c("Household mortgage debt to income",
#   "Owner-occupier mortgage debt to income",
#   "Owner-occupier mortgage LTI ratio (mean above the median)",
#   "Owner-occupier mortgage LTV ratio (mean above the median)",
#   "Buy-to-let mortgage LTV ratio (mean)",
#   "Monthly Housing Transactions",
#   "Approvals of loans secured on dwellings",
#   "Advances to homemovers",
#   "Advances to first time buyers",
#   "Advances to buy-to-let purchasers",
#   "House price to household disposable income ratio",
#   "Rental yield"), .before = 1)

coreIndicatorsDisplay[c(1:5,11:12),] <- sapply(coreIndicatorsDisplay[c(1:5,11:12),], FUN = round, digits = 2)
coreIndicatorsDisplay[6:10,] <- sapply(coreIndicatorsDisplay[6:10,], FUN = round, digits = 10)
# coreIndicatorsDisplay <- 

# implement line-breaks 
# names(coreIndicatorsDisplay) 
lineBreaks_table<- c( "Average \n1987-2006",	"Average\n2006",	"Minimum \nsince 1987",	"Maximum \nsince 1987",	"Previous \nvalue (oya)",	"Latest value\n(November 2018)", "Model Output")
coreIndicatorsDisplay <- coreIndicatorsDisplay %>%
  mutate_all(linebreak)
  
if (knitr:::is_html_output()){ names(coreIndicatorsDisplay) <- c( "Average 1987-2006",	"Average2006",	"Minimum since 1987",	"Maximum since 1987",	"Previous value (oya)",	"Latest value (November 2018)", "Model Output") }
# kbl(coreIndicatorsDisplay,booktabs =T)%>%
#   kable_styling(latex_options =c("striped","scale_down"))

coreIndicatorsDisplay %>%
  kbl(booktabs =T,escape =F,col.names =linebreak(lineBreaks_table, align ="c")) %>%
  kable_styling(latex_options =c("striped","scale_down"))

#####TODO: rounding numbers in table -> or set specific rows as integers
#####TODO: color the last column according to its values

```

```{r CoreIndicators, message=FALSE, warning=FALSE,  echo=FALSE}
# ONS wealth data https://www.ons.gov.uk/peoplepopulationandcommunity/personalandhouseholdfinances/incomeandwealth/datasets/totalwealthwealthingreatbritain
#
#- wealth inequality
# - deposits/credit
# - average deposit? - do I have that?
# - median DSR vul HH
# - median DSR non-vul HH
# - share of vul HH in indebted HH (I use this due to WEA data constraints)
# - median Age vul HH
# - median Age non-vul HH 

coreIndicators$top_10_wealth_share <- outfile%>%
    filter(`Sale HPI` > 0.98 & `Sale HPI` < 1.21) %>%
    pull(`Top 10% wealth share`)%>%
    mean()%>%
    round(digits = 5)

```


```{r buildingDistributionData, message=FALSE, warning=FALSE, results=FALSE,  echo=FALSE}

Wave_5_HH <- was_wave_5_hhold_eul_final%>%
  mutate(MortgagePayment1 = case_when(MPayM1W5 %in% c(-9:-6) ~ 0, TRUE~as.numeric(MPayM1W5)),
         MortgagePayment2 = case_when(MPayM2W5 %in% c(-9:-6) ~ 0, TRUE~as.numeric(MPayM2W5)),
         MortgagePayment3 = case_when(MPayM3W5 %in% c(-9:-6) ~ 0, TRUE~as.numeric(MPayM3W5)),
         totalMortgagePayments = MortgagePayment1 + MortgagePayment2 + MortgagePayment3,
         Mortgage1 = case_when(MVal1W5 %in% c(-9:-6) ~ 0, TRUE~as.numeric(MVal1W5)),
         Mortgage2 = case_when(MVal2W5 %in% c(-9:-6) ~ 0, TRUE~as.numeric(MVal2W5)),
         Mortgage3 = case_when(MVal3W5 %in% c(-9:-6) ~ 0, TRUE~as.numeric(MVal3W5)),
         totalMortgageDebt = Mortgage1 + Mortgage2 + Mortgage3,
         
  )%>%
  select(totalMortgageDebt,
         totalMortgagePayments,
         w5xshhwgt,                    # weight
         HRPDVAgeW5,                # age
         
         NumAdultW5, # number adults in household
         NumChildW5, # number of children
         Ten1w5_i, # tenure (only one is imputed)
         
         ## mortgages and housing
         MNumbNW5, #	Number mortgages or loans on property (only if no mortgage in W4 on this property
         MNumbOW5, #	Number mortgages or loans on property (only if mortgage in W4 on this property
         MNumbw5_i, #	Number of mortgages/loans
         MVal1W5, #	Amount still outstanding mortgageloan
         MValB1W5, #	Banded amount outstanding on mortgageloan (only about 100)
         MYLft1W5,        # Years left to run on mortgage
         # MPayM1W5, # Total monthly repayments for mortgage
         MPayB1W5, # Banded amount (about 25)
         MPastSPA1W5, # expecting to pay mortgage past pension age
         MIntRate1W5,	# Interest paid on mortgage?
         
         
         TotMortw5, # Total mortgage on main residence
         DVHValuew5, # Value of main residence
         OthMortw5_sum, #Total property debt
         DBurdHW5, # debt burden
         HBuyYrW5, #	Year bought main residence
         
         # finanaical wealth
         
         HFINWw5_sum, # Gross Financial Wealth
         HFINWNTw5_sum,   # Household Net financial Wealth (financial assets minus financial liabilities)
         
         DVTotGIRW5,                 # Household Gross Annual (regular) income
         DVTotNIRW5,                 # Household Net Annual (regular) income
         DVGrsRentAmtAnnualw5_aggr,  # Household Gross annual income from rent
         DVNetRentAmtAnnualw5_aggr,  # Household Net annual income from rent
         
         
         # List of other household variables of possible interest
         HRPDVILO3aW5,	# ILO employment status of HRP or partner
         
         HRPNSSEC3W5, # Socio-economic classification of HRP or partner
         
         
         HPHYSWW5,                   # Total Physical Wealth
         HPROPWw5,                   # Total property wealth
         TOTPENw5_aggr,              # Total hhold pension value
         TotWlthW5,                  # Total household wealth
         DVPropertyw5, # 5	Sum of all property values
         
         
         
         
  )%>%
  rename(Weight = "w5xshhwgt",
         Age = "HRPDVAgeW5", 
         NFW = "HFINWNTw5_sum",
         GrossFinancialWealth = "HFINWw5_sum",
         GrossAnnualRegularIncome = "DVTotGIRW5",                 # Household Gross Annual (regular) income
         NetAnnualRegularIncome = "DVTotNIRW5",                 # Household Net Annual (regular) income
         GrossAnnualRentalIncome = "DVGrsRentAmtAnnualw5_aggr",  # Household Gross annual income from rent
         NetAnnualRentalIncome = "DVNetRentAmtAnnualw5_aggr",  # Household Net annual income from rent
         
         # List of other household variables of possible interest
         Employment = "HRPDVILO3aW5",              # Employment Status of HRP or partner
         PhysicalWealth = "HPHYSWW5",                   # Total Physical Wealth
         NetHousingWealth = "HPROPWw5",                   # Total property wealth
         TotalPensionWealth = "TOTPENw5_aggr",              # Total hhold pension value
         TotalWealth = "TotWlthW5",                  # Total household wealth
         # NetAnnualSelfEmployedIncome = "DVNISEw5_aggr",              # Household Total Annual Net self employed income
         # NetAnnualEmployeeIncome = "DVNIEMPw5_aggr",             # Household Total Annual Net employee income
         # GrossAnnualInvestmentIncome = "DVGIINVw5_aggr",             # Household Gross annual income from investments
         # NetAnnualInvestmentIncome = "DVNIINVw5_aggr",             # Household Net annual income from investments
         GrossHousingWealth = "DVPropertyw5"
         
  )%>%
  filter(!is.na(Weight)) %>%# there is at least one observation where the weight is NA, which leads to problems when building the unweighted version
  mutate(finanicalMargin = NetAnnualRegularIncome/12 - totalMortgagePayments - 0.7*2749.667, # TODO better calculate this value on the spot ----
         monthsAbleToCover = GrossFinancialWealth/finanicalMargin, # negative value means finanical margin is negative
         vulnerable = case_when(monthsAbleToCover<0 & monthsAbleToCover > -8 & totalMortgagePayments !=0 ~ 1, 
                                TRUE ~ 0
         ),
         debtIsHeavyBurden = case_when(DBurdHW5 == 1 ~ 1,TRUE ~ 0)
  ) 


wave_5_for_graph <-Wave_5_HH %>% #Wave_5_HH %>%  weighted_Wave5
  filter(totalMortgagePayments != 0) %>%
  # mutate(MortgagePaymentsRecorded = case_when(totalMortgagePayments == 0 ~ FALSE, totalMortgagePayments != 0 ~ TRUE))%>%
  # filter(totalMortgageDebt !=0)%>%
  mutate(vulnerable = case_when(vulnerable == 0 ~ FALSE, vulnerable ==1 ~TRUE))%>%
  # mutate(HBuyYrW5 = case_when(HBuyYrW5 < 1960 ~ 0, TRUE~as.numeric(HBuyYrW5)))%>%
  # filter(HBuyYrW5 != 0)%>%
  # mutate(hasDebt = case_when())
  mutate(DSR = 12*totalMortgagePayments/ GrossAnnualRegularIncome)%>%
  mutate(DTI = totalMortgageDebt/GrossAnnualRegularIncome)



sortingData_for_figure <-  sortingData_data_vul_FTBSM%>% #sortingData_data_vul_FTBSM # sortingData_data_vul_noFTBSM sortingData_data_vul_noFTBSM_0.961
  filter(Debt < 0)%>%
  mutate(DTI = Debt/(-12* MonthlyGrossTotalIncome))%>%
  mutate(DSR = MonthlyMortgagePayments/MonthlyGrossTotalIncome)%>%
  mutate(hasDebt = case_when(Debt<0 ~ TRUE, TRUE ~ FALSE))
# mutate(MonthsOfMortgagePaymentsCovered_0.9 = BankBalance / (MonthlyDisposableIncome+492.7 - 0.9*median(MonthlyGrossTotalIncome, na.rm = TRUE)),
#        vulnerable_measure2 = case_when(MonthsOfMortgagePaymentsCovered_0.9 >-33240 & MonthsOfMortgagePaymentsCovered_0.9 <0 & Debt <0 ~ TRUE, TRUE ~ FALSE))
#        

## build data frame for calculting weighed mean -> share of vulnerable households in indebted households
wave_vul_weight <- Wave_5_HH%>%  # weighted_Wave5  # Wave_5_HH
  filter(totalMortgageDebt!=0)%>%
  filter(totalMortgagePayments != 0) %>%
  select(vulnerable,Weight)


```

We compare the finanically vulnerable households in our model with that of the fifth wave of the Wealth and Asset Survey (WEA). Using the same definition of financially vulnerable households presented above, the first values to compare are the share of financially vulnerable households in all households with mortgage debt. For the WEA the share of vulnerable households of all households with mortgage debt is `r formattable::percent(weighted.mean(wave_vul_weight$vulnerable, w = wave_vul_weight$Weight), digits = 1)` and for the model, using the same definition as introduced above, this share is `r formattable::percent(mean(outfile$"%vulHH of indebtedHH"), digits = 1)`.

```{r fig.cap="Debt-Service-Ratios of finanically vulnerable and non-vulnerable households in the Wealth and Asset Survey (left) and the model (right)",fig.subcap=c("Wealth and Assets", "Model output"),  fig.show='hold', message=FALSE, warning=FALSE, out.width='49%', results=FALSE,  echo=FALSE}


core_medians_WEA <- wave_5_for_graph %>%
  group_by(vulnerable) %>%
  summarise(coreIndicator = weighted.median(DSR, w = Weight))


graph <- wave_5_for_graph%>%
  ggplot(aes(DSR, fill = vulnerable, weight = Weight))+
  # ggtitle("Vulnerable households \n(subgroup: mortgage payments, N= 4,204,219 households)")+
  # ggtitle("Testing the differences in distribution between \nhouseholds with recorded mortgage payments and those without")+
  # ggtitle("WEA output (unweighed, and only HH with explicit mortgage payments)")+
  # scale_x_log10()+
  xlim(c(0,0.75))+
  geom_vline(
    data = core_medians_WEA, linetype = "dashed", size = 1,
    aes(xintercept = coreIndicator, colour = vulnerable)
  )

# graph + geom_density(alpha = 0.5, position = "identity" )
graph + geom_histogram(alpha = 0.5, position = "identity")


core_medians <- sortingData_for_figure %>%
  group_by(vulnerable) %>%
  summarise(coreIndicator = median(DSR, na.rm = TRUE))


sortingData_for_figure %>%
  ggplot(aes(DSR, fill = vulnerable))+
  # ggtitle("Model households")+ # \nsubgroup indebted households")+
  # ggtitle("Model output (over")+  #\nlowest income quartile exempt
  # geom_density(alpha = 0.5, position = "identity" )+
  geom_histogram(alpha = 0.5, position = "identity" )+
  xlim(c(0,0.75))+
  # scale_x_log10()+
  geom_vline(
    data = core_medians, linetype = "dashed", size = 1,
    aes(xintercept = coreIndicator, colour = vulnerable)
  )

```

<!-- median DSRs -->

The median DSR for non-vulnerable households in the WEA are for the `r formattable::percent(core_medians_WEA$coreIndicator[1], digits = 1)` for the model output `r formattable::percent(core_medians$coreIndicator[1], digits = 1)`, for vulnerable households these values are `r formattable::percent(core_medians_WEA$coreIndicator[2], digits = 1)` and `r formattable::percent(core_medians$coreIndicator[2], digits = 1)`, respectively[^3].

[^3]: Alternative measurement for the model is the mean of the median Age in each period - not the overall median of the Age distribution of all households over all periods (i.e. each households is recorded once per period). Then the vulnerable Age is `r round(mean(outfile$"medianAge vulHH"))`.

```{r fig.cap="Age of finanically vulnerable and non-vulnerable households in the Wealth and Asset Survey (left) and the model (right)", fig.subcap=c("Wealth and Assets", "Model output"), fig.show='hold', message=FALSE, warning=FALSE, out.width='49%', results=FALSE,  echo=FALSE}
core_medians_WEA <- wave_5_for_graph %>%
  group_by(vulnerable) %>%
  summarise(coreIndicator = weighted.median(Age, w = Weight))


graph <- wave_5_for_graph%>%
  ggplot(aes(Age, fill = vulnerable, weight = Weight))+
  # ggtitle("Vulnerable households \n(subgroup: mortgage payments, N= 4,204,219 households)")+
  # ggtitle("Testing the differences in distribution between \nhouseholds with recorded mortgage payments and those without")+
  # ggtitle("WEA output (unweighed, and only HH with explicit mortgage payments)")+
  # scale_x_log10()+
  xlim(c(20,80))+
  geom_vline(
    data = core_medians_WEA, linetype = "dashed", size = 1,
    aes(xintercept = coreIndicator, colour = vulnerable)
  )

# graph + geom_density(alpha = 0.5, position = "identity" )
graph + geom_histogram(alpha = 0.5, position = "identity")


core_medians <- sortingData_for_figure %>%
  group_by(vulnerable) %>%
  summarise(coreIndicator = median(Age, na.rm = TRUE))


sortingData_for_figure %>%
  ggplot(aes(Age, fill = vulnerable))+
  # ggtitle("Model households")+ # \nsubgroup indebted households")+
  # ggtitle("Model output (over")+  #\nlowest income quartile exempt
  # geom_density(alpha = 0.5, position = "identity" )+
  geom_histogram(alpha = 0.5, position = "identity" )+
  xlim(c(20,80))+
  # scale_x_log10()+
  geom_vline(
    data = core_medians, linetype = "dashed", size = 1,
    aes(xintercept = coreIndicator, colour = vulnerable)
  )
```

<!-- median Age -->

The median Age for non-vulnerable households in the WEA are for the `r round(core_medians_WEA$coreIndicator[1], digits = 0)` for the model output `r round(core_medians$coreIndicator[1], digits = 0)`, for vulnerable households these values are `r round(core_medians_WEA$coreIndicator[2], digits = 0)` and `r round(core_medians$coreIndicator[2], digits = 0)`, respectively.

# Model with saving motive for First-time buyers

```{r fig.cap="Debt-Service-to-Income ratio of household types - model withouth FTB saving motive (left) and with (right)", fig.subcap=c("no FTB saving motive", "FTB saving motive (baseline)"), fig.show='hold', message=FALSE, warning=FALSE, out.width='49%', results=FALSE,  echo=FALSE}
sortingData_for_figure_noFTBSM <-  sortingData_data_vul_noFTBSM%>%
  filter(Debt < 0)%>%
  mutate(DTI = Debt/(-12* MonthlyGrossTotalIncome))%>%
  mutate(DSR = MonthlyMortgagePayments/MonthlyGrossTotalIncome)%>%
  mutate(hasDebt = case_when(Debt<0 ~ TRUE, TRUE ~ FALSE))

core_means_noFTBSM <- sortingData_for_figure_noFTBSM %>%
  group_by(agent) %>%
  summarise(coreIndicator = median(DSR, na.rm = TRUE))

sortingData_for_figure_noFTBSM %>%
  ggplot(aes(DSR, fill = agent))+
  # ggtitle("no FTB SM")+ # \nsubgroup indebted households")+
  # ggtitle("Model households with top66%income FTB saving motive 60%\nsubgroup indebted households")+  #\nlowest income quartile exempt
  # geom_density(alpha = 0.5, position = "identity" )+
  geom_histogram(alpha = 0.5, position = "identity" )+
  xlim(c(0,0.75))+
  # scale_x_log10()+
  geom_vline(
    data = core_means_noFTBSM, linetype = "dashed", size = 1,
    aes(xintercept = coreIndicator, colour = agent)
  )


core_means <- sortingData_for_figure %>%
  group_by(agent) %>%
  summarise(coreIndicator = median(DSR, na.rm = TRUE))

sortingData_for_figure %>%
  ggplot(aes(DSR, fill = agent))+
  # ggtitle("FTB SM")+ # \nsubgroup indebted households")+
  # ggtitle("Model households with top66%income FTB saving motive 60%\nsubgroup indebted households")+  #\nlowest income quartile exempt
  # geom_density(alpha = 0.5, position = "identity" )+
  geom_histogram(alpha = 0.5, position = "identity" )+
  xlim(c(0,0.75))+
  # scale_x_log10()+
  geom_vline(
    data = core_means, linetype = "dashed", size = 1,
    aes(xintercept = coreIndicator, colour = agent)
  )
```

## subchapter for this appendix

```{r, turnover, echo = FALSE, warning=FALSE,message=FALSE, results= FALSE, fig.align='center', fig.dim = c(6, 4), fig.cap = "Housing market turnover (percentages of all houses transacted per months) - 6 months rolling averages", out.width='49%'}

outfile_tmp <- outfile %>%
  select("Sale nSales")

outfile_tmp <- as.matrix(outfile_tmp)/outfile$HousingStock
outfile_tmp <- as.data.frame(runmean(outfile_tmp, 6)) # build a rolling average (6 for 6 months)

outfile_tmp <- outfile_tmp %>%
  bind_cols(outfile$`Model time`, outfile$`Sale HPI`)
colnames(outfile_tmp) <- list("housing market turnover", "Period","HousePriceIndex")


# parameters for figure
relation_rhs_lhs <- 40
color_set_1 <- cet_pal(5, name = "r3") # color sets also used for later figure

outfile_tmp %>%
  filter(Period >= trough_period[troughs_limits[1]], Period <= trough_period[troughs_limits[2]])%>%
  ggplot(aes(x=Period))+
  geom_line( aes(y = `housing market turnover`), color = "darkred", size = 1.5)+
  geom_line( aes(y = HousePriceIndex / relation_rhs_lhs), size=1, linetype="dashed") +
  scale_y_continuous(
    # Features of the first axis
    name = "turnover (monthly sales to total housing stock)",
    # Add a second axis and specify its features
    sec.axis = sec_axis(~ . *relation_rhs_lhs, name="House Price Index"),
    expand = expansion(mult = c(0, 0.05)) # make the barplots start at the axis
  ) +
  scale_x_continuous(expand = expansion(mult = c(0,0)))+
  # theme_classic()+
  theme(legend.position = c(.85, .85)) +
  theme(legend.background = element_blank()) +  # Remove overall border
  theme(legend.key = element_blank()) +
  scale_fill_manual(values = color_set_1)
# labs(caption = "Notes: Your long reference footnote goes in here. UNd übrigensBesonders krass\n dass das so ist")
# scale_fill_viridis_d()

```

```{r, crossCorrelation, echo = FALSE, warning=FALSE,message=FALSE, results= FALSE, fig.cap = "Cross-Correlation of Financially Vulnerable Households and the House Price Index",  out.width='49%', fig.subcap=c("Vulnerable by Dissaving", "Vulnerable by Purchase"), fig.show='hold'}

ccf(outfile$`nowVul Dissaving`, outfile$`Sale HPI`, lag.max = 30, ylab = "cross-correlation", xlab = "lag in months", main = "")
ccf(outfile$`nowVul Purchase`, outfile$`Sale HPI`, lag.max = 30, ylab = "cross-correlation", xlab = "lag in months", main = "")

# ccf(outfile$`nowVul Purchase SSB`, outfile$`Sale HPI`, lag.max = 30, ylab = "cross-correlation", xlab = "lag in months", main = "purchase SSB")
# ccf(outfile$`nowVul Purchase FTB`, outfile$`Sale HPI`, lag.max = 30, ylab = "cross-correlation", xlab = "lag in months", main = "purchase FTB")
# ccf(outfile$`nowVul Purchase BTL`, outfile$`Sale HPI`, lag.max = 30, ylab = "cross-correlation", xlab = "lag in months", main = "purchase BTL")
# ccf(outfile$`nowVul Dissaving SSB`, outfile$`Sale HPI`, lag.max = 30, ylab = "cross-correlation", xlab = "lag in months", main = "Dissaving SSB")
# ccf(outfile$`nowVul Dissaving FTB`, outfile$`Sale HPI`, lag.max = 30, ylab = "cross-correlation", xlab = "lag in months", main = "Dissaving FTB")
# ccf(outfile$`nowVul Dissaving BTL`, outfile$`Sale HPI`, lag.max = 30, ylab = "cross-correlation", xlab = "lag in months", main = "Dissaving BTL")






```

# References {.unnumbered}

<!-- `r if (knitr:::is_html_output()) ' # References {-} '` -->
