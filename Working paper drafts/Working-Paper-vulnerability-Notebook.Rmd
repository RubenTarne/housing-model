---
title: "Mortgage Debt, the Housing Wealth Effect and Financial Vulnerability"
author: "Ruben Tarne"
date: "`r Sys.Date()`"
header-includes: 
- \usepackage{amsmath, amsfonts, longtable, tabulary, calc, subfig}
- \usepackage{floatrow}
- \floatsetup[figure]{capposition=top}
output:
  bookdown::html_document2: default
  html_notebook: default
  html_document:
    df_print: paged
  bookdown::pdf_document2:
    keep_tex: true
  pdf_document: default
  word_document: default
  bookdown: bookdown::gitbook
  bookdown::word_document2:
    toc: true
abstract: "Understanding the dynamics of households becoming financially vulnerable are useful to understand potential risk to the financial stability stemming from commercial banks' balance sheets. Two channels increasing financial vulnerability are of interest to us. Households taking on high levels of mortgage debt and homeowners dissaving in a housing boom via a housing wealth effect, diminishing their buffer to absorb income and interest rate shocks. In this paper we want to understand the relative importance of these two channels over the housing cycle. We employ an agent-based housing market model with a housing wealth effect to understand what household-types become vulnerable (and cease to be vulnerable) due to which channel and at what time in the housing cycle. We find that in several scenarios a housing wealth effect has a considerable impact on households' financial vulnerability. Moreover, heterogeneity is important as not all borrower-types are similarly affected."
bibliography: "library.bib"
biblio-style: "apalike"
link-citations: true
---

```{r, echo=FALSE, results='hide', warning=FALSE, message=FALSE}
library(here)
library(bookdown)
source(here::here("R code files\\R functions WP vulnerabilities.R"))
model_folder <- "test_agent_Data_0.155_0.888_0.98" # specify the folder of the model version used for this analysis
# true when running it for the first time in the workspace, set then to false
load_micro_data <- TRUE
```

# The Model

## Households' consumption

@Aladangady2017 showed that the overall housing wealth effect of 4.7% in the US is exclusively driven by households with above-median debt-service-to income ratios (DSR), which he defined as potentially credit constraint. Specificly, households with above-median DSRs have an estimated housing wealth effect of 12.7%, versus 0% for households with below-average DSRs. Similarly, @Zhang2019 finds a housing wealth effect for Dutch households with above-median debt-to-income ratios (DTI) of 10.3% versus 4.1% for households with below-median DTIs. These different responses to house price swings could be driven by a collateral or a precautionary saving channel. The collateral channel would imply that with falling house prices more credit-constraint households would have less ability to withdraw house equity, lowering their consumption spending. Similarly, households getting closer to the borrowing limit (due to falling house prices) could reduce their spending to increase their precautionary wealth [@Carroll2011]. We implement a consumption function where the housing wealth effect is mirroring these findings:

```{=tex}
\begin{equation}
c^{desired}_{i,t} = c_{0} + \alpha_{i} y^{m,disp}_{i,t} + \beta_{i}b_{i,t} + \gamma_{i,t} (w^{h}_{i,t} -  q_{i,t}),
(\#eq:dConsumption)
\end{equation}
```
where $c_{0}$ represents essential consumption, $y^{m,disp}_{i,t}$ monthly disposable income (i.e. after taxes and mortgage or rental payments), $b_{i,t}$ deposits, $w^{h}_{i,t}$ gross housing wealth and $q_{i,t}$ mortgage debt. $\alpha_{i}$ and $\beta_{i}$ are dependent on the on the agents' income, becoming weaker the richer the household is. This follows the observation that The finanical wealth effect ($\beta_{i}$)

The financial wealth effect seems to work more directly, potentially due to it

Mortgage debt is only acquired for purchasing houses. We decide against implementing a deliberate equity-withdrawal mechanism.

```{=tex}
\begin{equation}
c_{i,t} = 
\begin{cases}
\text{if } b_{i,t}-( c^{desired}_{i,t} - y^{m,disp}_{i,t} )<\zeta_{i,t} y^{m,disp}_{i,t} &\text{, }c_{i,t} = c_{0} + \alpha_{i} y^{m,disp}_{i,t}\\
\text{if } c^{desired}_{i,t} < c_{0} & \text{, } c_{i,t}=c_{0}\\
\text{else } & \text{, } c_{i,t}=c^{desired}_{i,t}
\end{cases}
(\#eq:consumption)
\end{equation}
```
\@ref(eq:dConsumption) bla blabla \@ref(eq:consumption)

# Financial vulnerability over the housing cycle

We define **financial vulnerability** following @Ampudia2016. First we introduce the financial margin of a household as its monthly income, less its monthly mortgage payments and a certain amount of basic living expenses:

```{=tex}
\begin{equation}
FM_{i,t} = y^{\text{net}}_{i,t} - \sum m_{i,k} - BLC,
(\#eq:FM)
\end{equation}
```
where $m$ is the monthly mortgage payment, $i$ the individiual households, $t$ the period (month) and $k$ the house the mortgage is paid for. $y^{\text{net}}_{i,t}$ is the households post-tax monthly income and $BLC$ the monhtly basic living costs, calculated as

```{=tex}
\begin{equation}
BLC = \rho y^{\text{median}},
(\#eq:BLC)
\end{equation}
```
with $\rho$ being set for $BCL$ to correspond to the poverty line, which is usually between 40% and 70% of median income [@Ampudia2016]. If a household has a negative finanical margin, it is financially distressed, meaning, income minus the mortgage payments is not enough to meet monthly basic living expenses. Then the houseshold can only meet all its expenses for a certain period of time, depending on its deposits. We define a household as finanically vulnerable if it can cover its negative financial margin for less than eight months[^1].

[^1]: The exposure at default (EAD) in the current model calibration is `r formattable::percent(mean(read_csv(here::here(paste0("Results/", model_folder, "/Output-run1.csv")))$"EAD Ampudia (70%BLC 8m)"))`, which is above the target value of the share of non-performing loans (like @Ampudia2016), which is at 2.4% between 2015-2019 [@EBA2019].

```{=tex}
\begin{equation}
b_{i,t} < 8 \cdot FM_{i,t}
(\#eq:finVul)
\end{equation}
```
## Matching the data

```{r, WEA, out.width = '50%'}
if(load_micro_data) was_wave_5_hhold_eul_final <- read_sav("~/UK-WEA-survey/UKDA-7215-spss/spss/spss24/was_wave_5_hhold_eul_final.sav")
Wave_5_HH <- was_wave_5_hhold_eul_final%>%
  mutate(MortgagePayment1 = case_when(MPayM1W5 %in% c(-9:-6) ~ 0, TRUE~as.numeric(MPayM1W5)),
         MortgagePayment2 = case_when(MPayM2W5 %in% c(-9:-6) ~ 0, TRUE~as.numeric(MPayM2W5)),
         MortgagePayment3 = case_when(MPayM3W5 %in% c(-9:-6) ~ 0, TRUE~as.numeric(MPayM3W5)),
         totalMortgagePayments = MortgagePayment1 + MortgagePayment2 + MortgagePayment3,
         Mortgage1 = case_when(MVal1W5 %in% c(-9:-6) ~ 0, TRUE~as.numeric(MVal1W5)),
         Mortgage2 = case_when(MVal2W5 %in% c(-9:-6) ~ 0, TRUE~as.numeric(MVal2W5)),
         Mortgage3 = case_when(MVal3W5 %in% c(-9:-6) ~ 0, TRUE~as.numeric(MVal3W5)),
         totalMortgageDebt = Mortgage1 + Mortgage2 + Mortgage3,
         
  )%>%
  select(totalMortgageDebt,
         totalMortgagePayments,
         w5xshhwgt,                    # weight
         HRPDVAgeW5,                # age
         
         NumAdultW5, # number adults in household
         NumChildW5, # number of children
         Ten1w5_i, # tenure (only one is imputed)
         
         ## mortgages and housing
         MNumbNW5, #	Number mortgages or loans on property (only if no mortgage in W4 on this property
         MNumbOW5, #	Number mortgages or loans on property (only if mortgage in W4 on this property
         MNumbw5_i, #	Number of mortgages/loans
         MVal1W5, #	Amount still outstanding mortgageloan
         MValB1W5, #	Banded amount outstanding on mortgageloan (only about 100)
         MYLft1W5,        # Years left to run on mortgage
         # MPayM1W5, # Total monthly repayments for mortgage
         MPayB1W5, # Banded amount (about 25)
         MPastSPA1W5, # expecting to pay mortgage past pension age
         MIntRate1W5,	# Interest paid on mortgage?
         
         
         TotMortw5, # Total mortgage on main residence
         DVHValuew5, # Value of main residence
         OthMortw5_sum, #Total property debt
         DBurdHW5, # debt burden
         HBuyYrW5, #	Year bought main residence
         
         # finanaical wealth
         
         HFINWw5_sum, # Gross Financial Wealth
         HFINWNTw5_sum,   # Household Net financial Wealth (financial assets minus financial liabilities)
         
         DVTotGIRW5,                 # Household Gross Annual (regular) income
         DVTotNIRW5,                 # Household Net Annual (regular) income
         DVGrsRentAmtAnnualw5_aggr,  # Household Gross annual income from rent
         DVNetRentAmtAnnualw5_aggr,  # Household Net annual income from rent
         
         
         # List of other household variables of possible interest
         HRPDVILO3aW5,	# ILO employment status of HRP or partner
         
         HRPNSSEC3W5, # Socio-economic classification of HRP or partner
         
         
         HPHYSWW5,                   # Total Physical Wealth
         HPROPWw5,                   # Total property wealth
         TOTPENw5_aggr,              # Total hhold pension value
         TotWlthW5,                  # Total household wealth
         DVPropertyw5, # 5	Sum of all property values
         
         
         
         
  )%>%
  rename(Weight = "w5xshhwgt",
         Age = "HRPDVAgeW5", 
         NFW = "HFINWNTw5_sum",
         GrossFinancialWealth = "HFINWw5_sum",
         GrossAnnualRegularIncome = "DVTotGIRW5",                 # Household Gross Annual (regular) income
         NetAnnualRegularIncome = "DVTotNIRW5",                 # Household Net Annual (regular) income
         GrossAnnualRentalIncome = "DVGrsRentAmtAnnualw5_aggr",  # Household Gross annual income from rent
         NetAnnualRentalIncome = "DVNetRentAmtAnnualw5_aggr",  # Household Net annual income from rent
         
         # List of other household variables of possible interest
         Employment = "HRPDVILO3aW5",              # Employment Status of HRP or partner
         PhysicalWealth = "HPHYSWW5",                   # Total Physical Wealth
         NetHousingWealth = "HPROPWw5",                   # Total property wealth
         TotalPensionWealth = "TOTPENw5_aggr",              # Total hhold pension value
         TotalWealth = "TotWlthW5",                  # Total household wealth
         # NetAnnualSelfEmployedIncome = "DVNISEw5_aggr",              # Household Total Annual Net self employed income
         # NetAnnualEmployeeIncome = "DVNIEMPw5_aggr",             # Household Total Annual Net employee income
         # GrossAnnualInvestmentIncome = "DVGIINVw5_aggr",             # Household Gross annual income from investments
         # NetAnnualInvestmentIncome = "DVNIINVw5_aggr",             # Household Net annual income from investments
         GrossHousingWealth = "DVPropertyw5"
         
  )%>%
  filter(!is.na(Weight)) %>%# there is at least one observation where the weight is NA, which leads to problems when building the unweighted version
  mutate(finanicalMargin = NetAnnualRegularIncome/12 - totalMortgagePayments - 0.7*2749.667,
         monthsAbleToCover = GrossFinancialWealth/finanicalMargin, # negative value means finanical margin is negative
         vulnerable = case_when(monthsAbleToCover<0 & monthsAbleToCover > -8 & totalMortgagePayments !=0 ~ 1, 
                                TRUE ~ 0
         ),
         debtIsHeavyBurden = case_when(DBurdHW5 == 1 ~ 1,TRUE ~ 0)
  ) 


wave_5_for_graph <-Wave_5_HH %>% #Wave_5_HH %>%  weighted_Wave5
  filter(totalMortgagePayments != 0) %>%
  # mutate(MortgagePaymentsRecorded = case_when(totalMortgagePayments == 0 ~ FALSE, totalMortgagePayments != 0 ~ TRUE))%>%
  # filter(totalMortgageDebt !=0)%>%
  mutate(vulnerable = case_when(vulnerable == 0 ~ FALSE, vulnerable ==1 ~TRUE))%>%
  # mutate(HBuyYrW5 = case_when(HBuyYrW5 < 1960 ~ 0, TRUE~as.numeric(HBuyYrW5)))%>%
  # filter(HBuyYrW5 != 0)%>%
  # mutate(hasDebt = case_when())
  mutate(DSR = 12*totalMortgagePayments/ GrossAnnualRegularIncome)%>%
  mutate(DTI = totalMortgageDebt/GrossAnnualRegularIncome)

core_means_WEA <- wave_5_for_graph %>%
  group_by(vulnerable) %>%
  summarise(coreIndicator = median(DSR))


graph <- wave_5_for_graph%>%
  ggplot(aes(DSR, fill = vulnerable))+
  # ggtitle("Vulnerable households \n(subgroup: mortgage payments, N= 4,204,219 households)")+
  # ggtitle("Testing the differences in distribution between \nhouseholds with recorded mortgage payments and those without")+
  # ggtitle("Vulnerable households\nall households WEA")+
  # scale_x_log10()+
  xlim(c(0,1))+
  geom_vline(
    data = core_means_WEA, linetype = "dashed", size = 1,
    aes(xintercept = coreIndicator, colour = vulnerable)
  )

# graph + geom_density(alpha = 0.5, position = "identity" )
graph + geom_histogram(alpha = 0.5, position = "identity")


if(load_micro_data) load(here::here(file = "Agent_Data_0.155_0.888_0.98.RData"))
sortingData_for_figure <-  sortingData_data_vul_FTBSM%>%
  filter(Debt < 0)%>%
  mutate(DTI = Debt/(-12* MonthlyGrossTotalIncome))%>%
  mutate(DSR = MonthlyMortgagePayments/MonthlyGrossTotalIncome)%>%
  mutate(hasDebt = case_when(Debt<0 ~ TRUE, TRUE ~ FALSE))%>%
  mutate(MonthsOfMortgagePaymentsCovered_0.9 = BankBalance / (MonthlyDisposableIncome+492.7 - 0.9*median(MonthlyGrossTotalIncome, na.rm = TRUE)),
         vulnerable_measure2 = case_when(MonthsOfMortgagePaymentsCovered_0.9 >-33240 & MonthsOfMortgagePaymentsCovered_0.9 <0 & Debt <0 ~ TRUE, TRUE ~ FALSE))

core_means <- sortingData_for_figure %>%
  group_by(vulnerable) %>%
  summarise(coreIndicator = median(DSR, na.rm = TRUE))


sortingData_for_figure %>%
  ggplot(aes(DSR, fill = vulnerable))+
  # ggtitle("Model households")+ # \nsubgroup indebted households")+
  ggtitle("Model households with top66%income FTB saving motive 60%\nsubgroup indebted households")+  #\nlowest income quartile exempt
  # geom_density(alpha = 0.5, position = "identity" )+
  geom_histogram(alpha = 0.5, position = "identity" )+
  xlim(c(0,1))+
  # scale_x_log10()+
  geom_vline(
    data = core_means, linetype = "dashed", size = 1,
    aes(xintercept = coreIndicator, colour = vulnerable)
  )

```

## Contributors to Financial Vulnerability

Following from our definition of financial vulnerability, households can become vulnerable if they:

-   Suffer decreases in their income (turning their finanical margin negative), by:

    -   Entering retirement
    -   Declines in their rental income

-   Increase their monthly mortgage payments, by:

    -   Purchasing property

-   Reduce their deposits below the threshold, by:

    -   Purchasing property (downpayment)
    -   Dissaving (induced by a wealth effect)

In the model, financial vulnerability is mainly driven by housing transactions and consumption. We operationalise both effects in order to understand how strong they are respectively. We look at why households that were not financially vulnerable in one period became vulnerable in the next. If the household just purchased a house, we attribute the change from non-vulnerable to vulnerable to this purchase (increases in monthly mortgage payments reduce the household's financial margin (Equation \@ref(eq:FM)) and downpayments deplete its deposits (Equation \@ref(eq:finVul)). If the household did not just buy a house but did dissave we attribute the vulnerability to consumption[^2]. All other cases of households becoming vulnerable are defined as *other*. These include households experiencing a decline in their income, turning their financial margin negative.

[^2]: Dissaving only occurs when households' consumption is induced by wealth. The marginal propensities to consume out of disposable income are for all agents below 1. To dissave, i.e. consume more than its disposable income, households need to hold assets.

```{r, contributorsVulnerability, echo = FALSE, warning=FALSE,message=FALSE, results= FALSE, fig.align='center', fig.dim = c(6, 4), fig.scap="lala", fig.cap = "Contributors to increases in the share of financially vulnerable households over the housing cycle - 6 months rolling averages"}
outfile <- read_csv(here::here(paste0("Results/", model_folder,"/Output-run1.csv")))

# get first the position of house price troughs from a smoothed HPI line
# (not as necessary for troughs as for peaks, which are more irreglar)
HPI_troughs <- find_peaks_smoothed( -outfile$`Sale HPI`, m=10, smoothedPerdiods = 6)
# translate the position of troughs into the corresponding periods to use later in graph
trough_period <- c(outfile$`Model time`[HPI_troughs])


outfile_tmp <- outfile %>%
  select("vulnerable by purchase", "vulnerable by dissaving",  "vulnerable by other")

outfile_tmp <- as.matrix(outfile_tmp)/outfile$TotalPopulation # adjust for % of total population
outfile_tmp <- as.data.frame(runmean(outfile_tmp, 6)) # build a rolling average (6 for 6 months)
colnames(outfile_tmp) <- list("purchase", "dissaving", "other") # abbreviate colnames for figure

outfile_tmp <- outfile_tmp %>%
  bind_cols(outfile$`Model time`, outfile$`Sale HPI`)%>%
  pivot_longer(c("purchase", "dissaving", "other"))  ## prepare for boxplots

colnames(outfile_tmp) <- list("Period","HousePriceIndex", "vulnerably_by", "value")
outfile_tmp$vulnerably_by <- factor(outfile_tmp$vulnerably_by, levels = c("other", "purchase", "dissaving"))

# parameters for figure
relation_rhs_lhs <- 200
color_set_1 <- cet_pal(3, name = "r3") # color sets also used for later figure

outfile_tmp %>%
  filter(Period >= trough_period[2], Period <= trough_period[3])%>%
  ggplot(aes(x=Period, fill = vulnerably_by))+
  geom_col( aes(y = value))+
  geom_line( aes(y = HousePriceIndex / relation_rhs_lhs), size=1, linetype="dashed") +
  scale_y_continuous(
    # Features of the first axis
    name = "share of households vulnerable",
    # Add a second axis and specify its features
    sec.axis = sec_axis(~ . *relation_rhs_lhs, name="House Price Index"),
    expand = expansion(mult = c(0, 0.05)) # make the barplots start at the axis
  ) +
  scale_x_discrete(expand = expansion(mult = c(0,0)))+
    theme_classic()+
  theme(legend.position = c(.85, .85)) +
  theme(legend.background = element_blank()) +  # Remove overall border
  theme(legend.key = element_blank()) +
  scale_fill_manual(values = color_set_1)+
  labs(caption = "Notes: Your long reference footnote goes in here. UNd übrigensBesonders krass\n dass das so ist")
# scale_fill_viridis_d()


```

```{r, echo = FALSE, warning=FALSE,message=FALSE, results= FALSE, fig.align='center', fig.dim = c(6, 4), fig.scap="lala", fig.cap = "Share of financially vulnerable households - by the cause of their vulnerability"}

outfile_tmp <- outfile %>%
  select("nowVul Purchase", "nowVul Dissaving",  "nowVul Other")

outfile_tmp <- as.matrix(outfile_tmp)/outfile$TotalPopulation # adjust for % of total population
outfile_tmp <- as.data.frame(runmean(outfile_tmp, 6)) # build a rolling average (6 for 6 months)
colnames(outfile_tmp) <- list("purchase", "dissaving", "other") # abbreviate colnames for figure

outfile_tmp <- outfile_tmp %>%
  bind_cols(outfile$`Model time`, outfile$`Sale HPI`)%>%
  pivot_longer(c("purchase", "dissaving", "other"))  ## prepare for boxplots

colnames(outfile_tmp) <- list("Period","HousePriceIndex", "vulnerably_by", "value")
outfile_tmp$vulnerably_by <- factor(outfile_tmp$vulnerably_by, levels = c("other", "purchase", "dissaving"))

# parameters for figure
relation_rhs_lhs <- 20


outfile_tmp %>%
  filter(Period >= trough_period[2], Period <= trough_period[3])%>%
  ggplot(aes(x=Period, fill = vulnerably_by))+
  geom_col( aes(y = value))+
  geom_line( aes(y = HousePriceIndex / relation_rhs_lhs), size=1, linetype="dashed") +
  scale_y_continuous(
    # Features of the first axis
    name = "share of households vulnerable",
    # Add a second axis and specify its features
    sec.axis = sec_axis(~ . *relation_rhs_lhs, name="House Price Index"),
    expand = expansion(mult = c(0, 0.05)) # make the barplots start at the axis
  ) +
  scale_x_discrete(expand = expansion(mult = c(0,0)))+
    theme_classic()+
  theme(legend.position = c(.85, .85)) +
  theme(legend.background = element_blank()) +  # Remove overall border
  theme(legend.key = element_blank()) +
  scale_fill_manual(values = color_set_1)+
  labs(caption = "Notes: Your long reference footnote goes in here. UNd übrigensBesonders krass\n dass das so ist")
# scale_fill_viridis_d()


```

```{r}

```
